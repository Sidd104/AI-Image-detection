<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Detection Website</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for animations and font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        .page-fade-in { animation: pageFadeIn 1s forwards; }
        @keyframes pageFadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .result-reveal {
            opacity: 0;
            animation: resultReveal 1s 0.3s forwards;
        }
        @keyframes resultReveal {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .drag-active { 
            border-color: #4f46e5; 
            background-color: #eef2ff; 
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2); 
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 sm:p-8">

    <div class="max-w-4xl mx-auto page-fade-in">
        
        <!-- Header -->
        <header class="flex items-center justify-center p-4 mb-10 bg-white rounded-xl shadow-lg border-b-4 border-indigo-600">
            <h1 class="text-3xl font-extrabold text-indigo-800 tracking-wide">AI Image Authenticator</h1>
        </header>

        <!-- Main Content Area -->
        <div id="appContainer" class="bg-white p-6 sm:p-10 rounded-2xl shadow-2xl">

            <!-- 1. HOME / UPLOAD VIEW (Default) -->
            <div id="uploadView" class="view-section">
                <h2 class="text-2xl sm:text-3xl font-bold text-stone-700 mb-8 text-center">Verify Image Source</h2>
                
                <!-- Drop Zone -->
                <div id="dropZone" class="border-4 border-dashed border-indigo-300 bg-indigo-50 p-10 rounded-xl transition duration-300 cursor-pointer text-center hover:border-indigo-500" onclick="document.getElementById('imageUpload').click()">
                    <p class="text-indigo-600 text-5xl mb-3">&#x1F4BE;</p>
                    <p class="font-bold text-xl text-indigo-700 mb-2">Drag & Drop Image Here</p>
                    <p class="text-sm text-stone-500">or click to browse (.jpg, .jpeg, .png)</p>
                    <!-- FIX: Removed onchange="previewAndDetect(event)" - listener added in JS module instead -->
                    <input type="file" id="imageUpload" accept="image/jpeg, image/png, image/jpg" class="hidden">
                </div>

                <!-- Detection Button -->
                <div class="mt-8">
                    <!-- Global function needed for inline HTML handler -->
                    <button id="detectButton" onclick="window.detectImageWrapper()" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-xl hover:bg-indigo-700 transition duration-300 shadow-md flex items-center justify-center space-x-2 opacity-50 cursor-not-allowed" disabled>
                        <span id="buttonText">Select an Image to Detect</span>
                        <div id="spinner" class="spinner hidden"></div>
                    </button>
                </div>
            </div>

            <!-- 2. RESULT VIEW (Hidden by default) -->
            <div id="resultView" class="view-section hidden">
                <div class="grid md:grid-cols-2 gap-8 items-start">
                    <!-- Image Preview -->
                    <div class="relative bg-slate-200 rounded-lg overflow-hidden shadow-lg aspect-square flex items-center justify-center p-2">
                        <img id="uploadedImage" src="" alt="Uploaded Image Preview" class="max-h-full w-auto h-auto object-contain rounded-lg transition duration-500 transform scale-100 hover:scale-[1.02]">
                    </div>

                    <!-- Result & Explanation -->
                    <div class="p-2">
                        <h3 class="text-xl font-bold text-stone-700 mb-3 border-b pb-2">Analysis Report</h3>
                        
                        <div class="mb-6 result-reveal">
                            <p class="text-lg font-semibold text-stone-500 uppercase">Detection Status</p>
                            <p id="resultText" class="text-5xl font-extrabold mt-1 leading-tight text-indigo-600">Analyzing...</p>
                        </div>
                        
                        <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-200 result-reveal">
                            <p class="text-lg font-semibold text-indigo-700 mb-2">Detailed Commentary:</p>
                            <p id="explanationText" class="text-stone-600 leading-relaxed text-sm">Waiting for AI analysis...</p>
                        </div>

                        <!-- Global function needed for inline HTML handler -->
                        <button onclick="window.showUploadViewWrapper()" class="mt-8 w-full py-3 bg-slate-200 text-stone-700 font-semibold rounded-xl hover:bg-slate-300 transition duration-300">
                            &#x21BB; Run New Scan
                        </button>
                    </div>
                </div>
            </div>

        </div>

        <!-- Custom Message Modal (Replacing alert()) -->
        <div id="messageModal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center transition-opacity z-50">
            <div class="bg-white p-8 rounded-xl shadow-2xl transform transition-all w-80 max-w-sm">
                <h3 id="modalTitle" class="text-2xl font-bold mb-3">Error</h3>
                <p id="modalMessage" class="text-stone-700 mb-6"></p>
                <!-- Global function needed for inline HTML handler -->
                <button onclick="window.hideMessageWrapper()" class="w-full py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition">Understood</button>
            </div>
        </div>

    </div>

    <script type="module">
        // --- Configuration & Environment Setup ---
        // Firebase global variables are required by the runtime environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // User-provided API Key (used for external calls)
        const apiKey = "AIzaSyCeEzeevYULmX0skCQwRD7ibIp3tmoYfco"; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const MAX_RETRIES = 5;

        // --- DOM Elements ---
        const uploadView = document.getElementById('uploadView');
        const resultView = document.getElementById('resultView');
        const fileInput = document.getElementById('imageUpload');
        const dropZone = document.getElementById('dropZone');
        const uploadedImage = document.getElementById('uploadedImage');
        const detectButton = document.getElementById('detectButton');
        const buttonText = document.getElementById('buttonText');
        const spinner = document.getElementById('spinner');
        const resultText = document.getElementById('resultText');
        const explanationText = document.getElementById('explanationText');
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');

        let currentObjectURL = null; // Stores the URL for resource cleanup

        // --- Utility Functions ---

        function showMessage(title, message, isError = true) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalTitle.classList.toggle('text-red-600', isError);
            modalTitle.classList.toggle('text-indigo-600', !isError);
            messageModal.classList.remove('hidden');
            messageModal.classList.add('flex');
        }

        function hideMessage() {
            messageModal.classList.remove('flex');
            messageModal.classList.add('hidden');
        }

        function isValidImage(file) {
            const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
            return file && validTypes.includes(file.type);
        }
        
        function releaseObjectURL() {
            if (currentObjectURL) {
                URL.revokeObjectURL(currentObjectURL);
                currentObjectURL = null;
            }
        }

        /**
         * Converts a File object to a Base64 string for the API payload.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64Data = reader.result.split(',')[1];
                    resolve(base64Data);
                };
                reader.onerror = (error) => {
                    reject(error);
                };
                reader.readAsDataURL(file);
            });
        }

        /**
         * Calls the Gemini API with exponential backoff for retries.
         */
        async function callGeminiAPI(payload, retries = 0) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error("API Error Response Body:", response.status, errorBody);

                    // Retry logic for transient errors (429 or 5xx)
                    if (retries < MAX_RETRIES && (response.status === 429 || response.status >= 500)) {
                        const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callGeminiAPI(payload, retries + 1);
                    }
                    
                    // Specific error message for non-transient failures
                    let message = `API call failed with status ${response.status}.`;
                    if (response.status === 400 || response.status === 401) {
                         message += " This could be due to an invalid API key, image size limits, or malformed request. Check console for details.";
                    }
                    throw new Error(message);
                }
                
                return response.json();
            } catch (error) {
                if (retries < MAX_RETRIES) {
                    const delay = Math.pow(2, retries) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callGeminiAPI(payload, retries + 1);
                }
                console.error("Final API error:", error);
                throw new Error(error.message || "Failed to connect to the AI service after multiple retries.");
            }
        }

        // --- View Transitions ---

        function showResultView(isLoading = false) {
            uploadView.classList.add('hidden');
            resultView.classList.remove('hidden');
            if (isLoading) {
                resultText.textContent = 'Analyzing...';
                resultText.className = 'text-5xl font-extrabold mt-1 leading-tight text-indigo-600';
                explanationText.textContent = 'Uploading image and running deep-pattern AI analysis. Please wait...';
            }
        }

        function showUploadView() {
            // Reset state
            fileInput.value = '';
            uploadedImage.src = '';
            releaseObjectURL();
            
            // Reset button
            detectButton.disabled = true;
            detectButton.classList.add('opacity-50', 'cursor-not-allowed');
            buttonText.textContent = 'Select an Image to Detect';
            
            // Show upload view
            resultView.classList.add('hidden');
            uploadView.classList.remove('hidden');
        }

        // --- Core Application Logic ---

        function previewImage(file) {
            if (!isValidImage(file)) {
                showMessage("Invalid File Type", "Please upload only .jpg, .jpeg, or .png image files.", true);
                fileInput.value = '';
                return false;
            }
            
            // 1. Clean up and create new URL
            releaseObjectURL();
            currentObjectURL = URL.createObjectURL(file);
            uploadedImage.src = currentObjectURL;

            // 2. Enable detection button
            detectButton.disabled = false;
            detectButton.classList.remove('opacity-50', 'cursor-not-allowed');
            buttonText.textContent = 'Analyze Image';
            
            return true;
        }

        function previewAndDetect(event) {
            const file = event.target.files[0];
            if (file && previewImage(file)) {
                // Automatically trigger detection on successful file selection
                detectImage();
            }
        }

        async function detectImage() {
            if (fileInput.files.length === 0 || detectButton.disabled) {
                return; // Guard clause: should not be clickable if disabled/no file
            }

            const file = fileInput.files[0];

            // 1. Set loading state and show result view
            showResultView(true);

            // Set loading indicators on the button (if called from upload view)
            detectButton.disabled = true;
            buttonText.classList.add('hidden');
            spinner.classList.remove('hidden');
            
            try {
                // 2. Convert file to Base64
                const base64Image = await fileToBase64(file);

                // 3. Construct API Payload
                const systemPrompt = "Analyze the following image. Based on visual artifacts, texture anomalies, lighting consistency, and typical generative model signatures (like unnatural perfect symmetry or pattern repetition), classify it as either 'AI-GENERATED' or 'REAL IMAGE'. Start your response with the classification in all capital letters followed by a colon (e.g., 'REAL IMAGE: [Explanation]'). Then, provide a detailed, single-paragraph explanation supporting your classification.";
                
                const payload = {
                    contents: [{ 
                        parts: [
                            { text: "Classify this image as 'AI-GENERATED' or 'REAL IMAGE'." },
                            {
                                inlineData: {
                                    mimeType: file.type,
                                    data: base64Image
                                }
                            }
                        ]
                    }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    }
                };

                // 4. Call API
                const result = await callGeminiAPI(payload);

                // 5. Parse Response
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text || "ANALYSIS FAILED: Could not retrieve a clear classification from the AI model.";

                // Attempt to extract classification (e.g., "AI-GENERATED: ...")
                const classificationMatch = text.match(/^(AI-GENERATED|REAL IMAGE):\s*(.*)/i);
                
                let classification = "UNKNOWN";
                let explanation = text;

                if (classificationMatch) {
                    classification = classificationMatch[1].toUpperCase();
                    explanation = classificationMatch[2].trim();
                } else if (text.toUpperCase().includes('AI-GENERATED')) {
                    classification = "AI-GENERATED";
                    explanation = text;
                } else if (text.toUpperCase().includes('REAL IMAGE')) {
                    classification = "REAL IMAGE";
                    explanation = text;
                }

                // 6. Update UI
                const icon = classification === "AI-GENERATED" ? " ðŸ¤–" : classification === "REAL IMAGE" ? " âœ…" : " â“";
                resultText.textContent = classification + icon;
                
                resultText.className = 'text-5xl font-extrabold mt-1 leading-tight';
                if (classification === "AI-GENERATED") {
                    resultText.classList.add('text-red-600');
                } else if (classification === "REAL IMAGE") {
                    resultText.classList.add('text-green-600');
                } else {
                    resultText.classList.add('text-yellow-600');
                }

                explanationText.textContent = explanation;

            } catch (error) {
                console.error("Detection Error:", error);
                showMessage("AI Detection Failed", error.message || "An unexpected error occurred while communicating with the AI service. Check your API key or try again later.", true);
                
                // Set result to error state
                resultText.textContent = "ERROR ðŸ›‘";
                resultText.className = 'text-5xl font-extrabold mt-1 leading-tight text-red-600';
                explanationText.textContent = "Failed to run detection. See the error message above and the browser console for details.";

            } finally {
                // Reset button visual state (only visible in upload view, but good practice to reset)
                detectButton.disabled = false;
                buttonText.classList.remove('hidden');
                spinner.classList.add('hidden');
            }
        }
        
        // --- Expose functions to the global scope for inline HTML handlers ---
        // FIX: Create global wrappers for functions called via onclick attributes
        window.showUploadViewWrapper = showUploadView;
        window.hideMessageWrapper = hideMessage;
        window.detectImageWrapper = detectImage;

        // --- Drag and Drop Handlers ---
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-active');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-active');
            const files = e.dataTransfer.files;
            
            if (files.length > 0) {
                const file = files[0];
                if (previewImage(file)) {
                    // Update the file input element to store the dropped file
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    
                    // Automatically trigger detection on successful drop
                    detectImage();
                }
            }
        });

        // --- Initial Load & Event Listeners ---
        showUploadView();

        // FIX: Attach the event listener here where the function is in scope
        fileInput.addEventListener('change', previewAndDetect);
    </script>
</body>
</html>